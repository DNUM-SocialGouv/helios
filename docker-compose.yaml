version: '3.9'

services:
  postgres:
    image: postgres:13.6-alpine
    container_name: helios_db
    ports:
      - target: 5432
        published: 5432
    env_file:
      - .env.docker
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql/data

  migrations:
    image: flyway/flyway:8.5.9-alpine
    command: -connectRetries=5 migrate
    volumes:
      - ./configuration:/flyway/conf
      - ./src/backend/configuration/migrations:/flyway/sql
    depends_on:
      - postgres

  postgres-test:
    image: postgres:13.6-alpine
    container_name: helios_test_db
    ports:
      - target: 5432
        published: 5433
    env_file:
      - .env.docker
    volumes:
      - type: volume
        source: postgres_data_test
        target: /var/lib/postgresql/data

volumes:
  postgres_data:
  postgres_data_test:
